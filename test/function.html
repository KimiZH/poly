<!DOCTYPE HTML>
<html lang="en">

<head>
<title>function tests</title>

<script>

	curl = {
		baseUrl: '../',
		paths: {
			curl: 'test/curl'
		},
		packages: [
			{ name: 'poly', location: '.', main: 'poly' }
		]
	};

</script>

<script src="curl.js"></script>

<script>

var natives = {
	bind: Function.prototype.bind
};

// First, test that poly!string doesn't clobber native methods
curl(['poly!poly/function'], function () {

	function test () {}
	// Note: these tests won't run in evirons that don't support .trim()
	if (natives.bind) {
		assertFalse('shim doesn\'t clobber bind', function () { return test.bind == natives.bind; });
	}

}).next(['curl/_privileged'], function (priv) {

	// remove poly/string from cache
	delete priv.cache['poly!poly/function'];
	delete priv.cache['poly/function'];
	// For testing in an ES env, remove shimmed methods first
	delete Function.prototype.bind;

}).next(['poly!poly/function'], runTests);


	function runTests () {

		function test () { return this.a; }

		var method = {
			foo: function () { return this.a; }
		}.foo;

		// check for existence of string prototype methods
		for (var m in natives) {
			assertTrue(m + ' exists', function () {
				return typeof test[m] == 'function';
			});
		}

		// test bind
		assertEquals('bind calls a function in context', function () {
			return test.bind({ a: 42 })();
		}, 42);
		assertEquals('bind calls a method in context', function () {
			return method.bind({ a: 42 })();
		}, 42);
		assertEquals('bind calls a native object\'s method in context', function () {
			var aDate, toString;
			aDate = new Date('1/1/2000');
			toString = aDate.toString.bind(aDate);
			return toString();
		}, new Date('1/1/2000').toString());

	}

	function assertEquals (name, test, value) {
		return runTest(name, test, value);
	}

	function assertTrue (name, test) { return runTest(name, test, true); }

	function assertFalse (name, test) { return runTest(name, test, false); }

	function runTest (name, test, value) {

		try {
			var actual = test();
			output(name + ':', actual === value ? 'succeeded' :
				('failed: expected <<' + value + '>>, got <<' + actual + '>> **********'));
		}
		catch (ex) {
			fail(name + ':' + 'exception thrown: ' + ex.message + ' **********');
		}
	}

	function fail (msg) {
		output(msg);
	}

	function output () {
		var logNode, args;
		args = [].slice.call(arguments);
		curl(['curl/domReady'], function () {
			var msgNode, message;
			logNode || (logNode = document.getElementById('output'));
			msgNode = document.createElement('div');
			message = args.join(' ');
			msgNode.appendChild(document.createTextNode(message));
			logNode.appendChild(msgNode);
		});
	}

</script>

</head>

<body>

<div id="output"></div>

</body>
</html>
